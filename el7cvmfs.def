Bootstrap: yum
OSVersion: 7
MirrorURL: http://mirror.centos.org/centos-%{OSVERSION}/%{OSVERSION}/os/$basearch/
UpdateURL: http://mirror.centos.org/centos-%{OSVERSION}/%{OSVERSION}/updates/$basearch/
Include: yum yum-utils bash bash-completion gawk util-linux coreutils sudo curl fuse fuse-libs fuse3 fuse3-libs bindfs

%labels
    Author Adrian.Sevcenco@spacescience.ro
    Version 0.0.1
    Description Minimal el7, HEP_OSlibs + cvmfs (configs: default+egi+osg) container


%help
Generic HEP oriented container (it includes HEP_OSlibs dependency list)
that allows mounting of CVMFS repositories without any host requirement.
The proxies are defined as generic PAC urls, with fallback to DIRECT.
CVMFS configuration is the merge of cvmfs-config-default cvmfs-config-egi cvmfs-config-osg
The default is either run(exec) the argument list or just start bash(exec, login)

%setup
mkdir -p ${SINGULARITY_ROOTFS}/etc/cvmfs

mkdir -p el7cvmfs.dock
git clone https://github.com/adriansev/el7cvmfs.dock
cp -r ${tmpdir}/etc_cvmfs/ ${SINGULARITY_ROOTFS}/etc/cvmfs/
rm -rf el7cvmfs.dock


%files
default.local /etc/cvmfs/default.local
sudoers_cvmfs /etc/sudoers

%post
mkdir -p /cvmfs /etc/cvmfs /var/lib/cvmfs && \
yum fs filter languages en && yum fs filter documentation && \
yum -y install \
https://linuxsoft.cern.ch/wlcg/centos7/x86_64/wlcg-repo-1.0.0-1.el7.noarch.rpm \
https://ecsft.cern.ch/dist/cvmfs/cvmfs-release/cvmfs-release-latest.noarch.rpm \
https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm && \
yum -y install \
bash bash-completion bash-completion-extras util-linux coreutils gawk sudo curl environment-modules \
fuse fuse-libs fuse3 fuse3-libs bindfs  \
git python unzip make autoconf automake texinfo libtool bison flex which gcc-gfortran gcc-c++ swig rsync \
mariadb maridb-devel curl curl-devel bzip2 bzip2-devel gettext gettext-devel freetype freetype-devel \
libpng libpng-devel sqlite sqlite-devel ncurses ncurses-devel libxml2 libxml2-devel \
motif motif-devel tk tk-devel glfw glfw-devel \
mesa-libGLU-devel libX11-devel libXpm-devel libXext-devel libXft-devel \
pciutils-devel perl-ExtUtils-Embed \
python3 python3-libs python3-devel python3-pip python3-wheel python3-setuptools python3-rpm-macros python3-other-rpm-macros \
java-11-openjdk java-11-openjdk-devel java-11-openjdk-headless \
centos-release-scl HEP_OSlibs && \
yum install -y --disablerepo=UMD* cvmfs cvmfs-fuse3 cvmfs-config-none && \
yum -y update && \
rm -rf /var/cache/yum/* ;

%runscript
#!/usr/bin/bash

ARGS="${@}"
[[ -n "${ARGS}" ]] && exec "${@}" || exec bash -l --

